Quick Setup for VPC with Devops Platform as a Service (DPaaS)
This is a guide to help you quickly create a VPC using the Infrastructure as Code (IaC) framework found in the Devops Platform as a Service
(DPaaS) ADO Project found here:
https://samcado.visualstudio.com/DEVOPS_Platform_as_a_Service

Summary of Requirements
Service Connections
Two Service connections are need for deploying AWS infrastructure into an AWS account:

A Terraform AWS Service account:
An AWS Service account:
CIDR Block
From the DevOps Platform Engineering team obtain "CIDR" block to use for your environment. For environments using Kubernetes clusters, it is
best to request a larger CIDR block - a "/22" ("slash twenty-two"). For most applications, a "/24" CIDR block will suffice.

NOTE:
A CIDR block is a contiguous set of IP addresses defined by a Classless Inter-Domain Routing (CIDR) notation, which uses an IP address followed
by a slash and a number (e.g., 192.168.1.0/22) to specify the number of bits reserved for the network portion. This notation is used by Internet
Service Providers (ISPs) and organizations to efficiently allocate, manage, and route IP addresses by dividing larger blocks into smaller, more
manageable subnets, thereby improving network efficiency and security.

Application Name
Almost all of the code in DPaaS repositories require you have an "Application" name associated with them. Ideally, this "Application" name
should be unique and succint. Your "Application" name can be upper and lower case letters. Your "Application" name will be used these places:

As the value for your Terraform appname variable.
As the value for your application parameter when using Azure DevOps (ADO) templates from the DPaaS deploy-templates repository.
As part of the name of your ADO repository concatenated with the string "-pipeline". This is the recommended standard / best practice.
As part of the name of your ADO pipeline concatenated with the string "-pipeline". This is the recommended standard / best practice.
NOTE:
When using the main deployment script from the deploy-templates repository (deploy/tf-create-infra-template.yml) the value of your Terraform
appname variable must be equal to the value for your application parameter in your pipeline YAML files.

Environment Name
Almost all of the code in DPaaS repositories require you have an "environment" name associated with them. Usually, this "environment" name
will be something like "dev", "qa", "sit", "test", or "prod". Your "environment" name should be all lower case letters: this is the
requirement of most of the code in the DPaaS repositories. Your "environment" name will be used in these places:

As the value for your Terraform env variable.
As the value for your environment parameter when using Azure DevOps (ADO) templates from the DPaaS deploy-templates repository.
As the root name of the *.tfvars file where you will define values for the variables for your VPC deployment.
NOTE:
When using the main deployment script from the deploy-templates repository (deploy/tf-create-infra-template.yml) the value of your Terraform
env variable must be equal to the value for your environment parameter in your pipeline YAML files. Also, the value of your env variable
should be used as the root of you <environment>.tfvars file.

Files Required
For a quick VPC setup using the DPaaS framework, you will need these files:

azure-pipeline.yml: This will be your main pipeline file and is common practice in DPaaS project for the main file to have this name.
vpc.tf: This will instantiate the DPaaS VPC module by referencing the module's repository name (source = "../vpc").
variables_vpc.tf: This defines all the variables used to deploy this quick setup.
vars/sandbox.tf: This will be the file where you define values for all of the variables used in your "sandbox" environment VPC.
locals.tf: This is just a very simple example where you can define AWS tags for you AWS VPC deployed with this code.
gitCheckouts.yml: This is needed to pull (AKA "check out") all the source you need from various ADO project repositories.
special_pipeline_variables.tf: Defines Terraform variables that have values set by the deploy-templates code.
NOTE:
Copy both the vpc.tf and
variables_vpc.tf
from here:
https://samcado.visualstudio.com/DEVOPS_Platform_as_a_Service/_git/IAC-master-code?version=GBmain

File Contents
Your main ADO pipeline YAML file (azure-pipeline.yml) should have contents like the following example:


resources:
  repositories:
    - repository: templates
      type: git
      name: DEVOPS_Platform_as_a_Service/deploy-templates
      ref: refs/tags/7.7.0
    - repository: vpc
      type: git
      name: DEVOPS_Platform_as_a_Service/vpc
      ref: refs/tags/4.2.0
    - repository: security-groups
      type: git
      name: DEVOPS_Platform_as_a_Service/security-groups
      ref: refs/tags/2.40.0
    - repository: iam-controls
      type: git
      name: DEVOPS_Platform_as_a_Service/iam-controls
      ref: refs/tags/3.0.0

trigger: none

parameters:
- name: sandbox
  displayName: Deploy QuickSetup vpc sandbox env to DevopsSandbox 889050139813
  type: boolean
  default: false
- name: terrformPLANonly
  displayName: tfPlanOnly (check == true)
  type: boolean
  default: false

stages:
  - template: deploy/tf-create-infra-template.yml@templates
    parameters:
      environment: sandbox
      environmentDisplayName: sandbox
      tfServiceConnection: DevopsSandbox-889050139813-DevopsIACSvcVpc-us-east-1
      awsServiceConnection: DevopsSandbox-889050139813-DevopsIACSvcVpc
      tfVersion: 1.13.3
      application: QuickSetup
      pipelineSrcDir: $(Build.Repository.Name)
      tfPlanOnly: ${{ parameters.terrformPLANonly }}
      regionName: us-east-1
      checkoutTemplate: gitCheckouts.yml
Your vars/sandbox.tf file (vars/<environment>.tf) should have contents like the following example - but your CIDR block should be
different


# VPC
network_type   = "nonprod"
env            = "sandbox"
region         = "us-east-1"
appname        = "QuickSetup"
vpccidr        = "172.24.72.0/24"
privatesubnets = ["172.24.72.0/27", "172.24.72.32/27", "172.24.72.64/27"]
dbsubnets      = ["172.24.72.96/27", "172.24.72.128/27", "172.24.72.160/27"]
publicsubnets  = ["172.24.72.208/28", "172.24.72.224/28", "172.24.72.240/28"]
transitgwid    = "tgw-0da90b01c5f2c8024"
Your locals.tf file should contain any AWS tag key / value pair you want to set like this example:


locals {
  tags = {
    "samc:appid" = var.appname
    "samc:env"   = var.env
  }
}
Your GIT checkout file (gitCheckouts.yml) should have contents like this example:


steps:
- checkout: vpc
  displayName: Get vpc module - QSVvpc

- checkout: security-groups
  displayName: Get security-groups module - QSVsgs

- checkout: iam-controls
  displayName: Get iam-controls module - QSViam
The "pass through variables" file (AKA specical_pipeline_variables.tf) should have contents like the following example:


variable "artifactory_user" {
  description = "READ ONLY JFrog user account - used to download software from JFrog"
  type        = string
}

variable "artifactory_pass" {
  description = "READ ONLY JFrog user acount's pwd - used to download software from JFrog"
  type        = string
}
Comments
The DPaaS module has dependencies on the following two modules:

security-groups:
iam-controls:
